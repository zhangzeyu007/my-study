<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JWT token</title>
  </head>
  <body>
    <script>
        /*
        JWT(JSON Web Token) 是一种开放标准,用于在各方之间安全地传递信息。它是一种基于 JSON 的访问令牌,
        可以在客户端和服务器之间传递,用于身份验证和信息交换。JWT 的工作原理如下:
      1.  JWT 的结构
        JW 由三部分组成,用 . 分隔开,格式如下:
        xxxxx.yyyyy.zzzzz
        Header(头部)
      头部通常包含两部分:令牌类型(typ)和所使用的散列算法(alg),例如:
              {
            "typ": "JWT",
            "alg": "HS256"
          }
      2.  Payload(载荷)
        载荷包含一些声明信息,如已注册声明、公共声明和私有声明等。常见的声明有:
        iss(issuer)：发行人
        exp(expiration time)：过期时间
        aud(audience)：受众
        sub(subject)：主题
        iat(issued at)：发布时间
        其他自定义声明
              {
          "sub": "1234567890",
          "iss": "auth-server",
          "exp": 1516239022,
          "name": "John Doe"
        }
      3. Signature(签名)
        签名用于验证 JWT 的完整性和发行人身份。签名由三部分组成
        Header (Base64Url 编码后)
        Payload (Base64Url 编码后)
        Secret (服务端的私钥,用于生成签名)
        将以上三者使用 . 连接后,使用 Header 中指定的算法如 HMAC SHA256 或 RSA 进行加密,得到签名部分。
        签名部分就是 JWT 的第三部分。
        JWT 的工作流程
        1.用户发送用户名和密码到服务器进行身份验证。
        2.服务器验证成功后,使用私钥生成一个 JWT 并发送给客户端。
        3.客户端将收到的 JWT 保存在 Cookie 或 localStorage 等存储介质中。
        4.客户端在后续每次请求时,将 JWT 放入 HTTP 头(Authorization)发送给服务器。
        5.服务器使用公钥或私息,根据声明信息执行相应操作
        JWT 的优点
        1.无状态:服钥验证 JWT 的签名是否有效,并解析出其中的声明信务器不需要存储会话信息,减轻了服务器的负担。
        2.跨域认证:Cookie 是不可跨域的,而 JWT 可以在任意域中传递,实现跨域认证非常方便。
        3.更高效:在服务器不需要为每个请求存储会话信息,减少了存储压力,也减少了 CPU 开销。
        4.更加安全:不需要在服务器存储 session 信息,减少了受到攻击的风险。
        JWT 的缺点
        1.不可回收:无法在 JWT 生成后更改其内容,一旦签发就难以废止,除非服务器维护一个黑名单。
        2.有效期限制:为减少盗用的风险,JWT 的有效期不易设置太长。
        3.无法使令牌完全失效:JWT 本身包含认证信息,无法使令牌的整个有效期失效。
        4.性能问题:服务端需要对 JWT 进行签名和解密,计算量较大。
        */
        /**
         * JWT Token 失效是指令牌在到期前被撤销或者作废的过程。由于 JWT 是无状态的,不能直接使其失效,
         * 因此需要采取一些特殊的处理方式。通常有以下几种常见的 JWT Token 失效工作流程:
         * 1. 使用黑名单
            将已失效的 JWT Token 存储在服务器端的黑名单中。每次服务器收到请求时,会先检查 Token
            是否存在于黑名单中,如果存在则拒绝该请求。
            工作流程如下:
            客户端发送 JWT Token 进行认证。
            服务器检查黑名单,如果 Token 在黑名单中则拒绝请求。
            如果 Token 有效,则服务器处理请求并响应客户端。
            当需要使 Token 失效时,服务器将该 Token 加入黑名单中。
            黑名单方案的缺点是需要在服务器端存储黑名单数据,当黑名单数据较大时可能会影响系统性能。
            2. 使用白名单
            与黑名单相反,使用白名单存储所有有效的 JWT Token。服务器在收到请求时,检查 Token
            是否存在于白名单中。
              工作流程如下:
              客户端发送 JWT Token 进行认证。
              服务器检查白名单,如果 Token 不在白名单中则拒绝请求。
              如果 Token 有效,则服务器处理请求并响应客户端。
              当需要使 Token 失效时,服务器将该 Token 从白名单中移除。
              白名单方案相比黑名单更加安全,但也需要存储所有有效 Token 信息,存储压力较大。
        */

        /*
         * 将 JWT Token 相关信息存储在数据库中,包括 Token 字符串、过期时间、撤销时间等。
         * 服务器可根据数据库中的信息判断 Token 是否有效或已失效。
          工作流程如下:
          客户端发送 JWT Token 进行认证。
          服务器查询数据库,获取该 Token 的相关信息。
          如果 Token 已过期或已被撤销,则拒绝请求。
          如果 Token 有效,则服务器处理请求并响应客户端。
          当需要使 Token 失效时,服务器更新数据库中该 Token 的撤销时间。
          这种方案可以更灵活地管理 JWT Token 的生命周期,但需要一定的数据库开销。
         4. 使用 Redis 等缓存服务
          将 JWT Token 信息存储在内存缓存中,如 Redis。服务器可以快速查询缓存中的数据,判断 Token 是否有效。
          工作流程与使用数据库存储方案类似,只是将存储介质改为了内存缓存。
          这种方案查询速度更快,但需要注意缓存的可用内存大小以及重启后Token失效等问题。
          实际应用中,可以根据系统的具体需求和约束条件选择合适的失效方案,或结合多种方案的优点。
          除了上述流程外,也可以在 JWT Payload 中加入一些额外的元数据,以标记 Token 是否失效。
          无论采用何种方案,都需要平衡可靠性、性能和实现复杂度之间的权衡。同时还要注意安全性,
          如避免重放攻击、密钥泄露等潜在风险。正确管理 JWT Token 的生命周期对系统的认证和授权机制至关重要。
       * /
    </script>
  </body>
</html>
